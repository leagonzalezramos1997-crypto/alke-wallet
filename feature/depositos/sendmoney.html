<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depositar - Alke Wallet</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../main/menu/styles.css">
</head>
<body>
    <div class="app-container d-flex">
        <div class="overlay" id="overlay"></div>
        <nav class="sidebar" id="sidebar"> 
            <div class="toggle-container">
                <button class="toggle-Btn" id="toggleBtn">
                    <i class="bi bi-arrow-left-circle-fill"></i>
                </button>
            </div>        
            <div class="logo-container">
                <img src="../../main/menu/icons/logo.svg" alt="Logo Alke Wallet" class="logo">
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="../../main/menu/menu.html" class="nav-link">
                        <img src="../../main/menu/icons/cartera.svg" alt="Icono de banco" width="30" height="30" class="nav-logo">
                        <span class="link-text" style="margin-left: 6px;">Cartera</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./deposit.html" class="nav-link active">
                        <img src="../../main/menu/icons/deposit.svg" alt="Icono de deposito" width="30" height="30" style="margin-left: 3px;" class="nav-logo">
                        <span class="link-text" style="margin-left: 3px;">Depositar</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="./sendmoney.html" class="nav-link">
                        <img src="../../main/menu/icons/transferencia.svg" alt="Icono de enviar dinero" width="30" height="30" class="nav-logo">
                        <span class="link-text" style="margin-left: 6px;">Transferir</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="../transacciones/transactions.html" class="nav-link">
                        <img src="../../main/menu/icons/transacciones.svg" alt="Icono de transacciones" width="30" height="30" class="nav-logo">
                        <span class="link-text" style="margin-left: 6px;">Historial</span>
                    </a>
                </li>
            </ul>
        </nav>
        <main class="main-content">
            <div class="content-body">
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card card-contactos">
                <div class="card-body">
                    <h5 class="card-title">Agregar Contacto</h5>
                    <form id="formAgregarContacto">
                        <div class="form-group">
                            <label for="nombreContacto">Nombre</label>
                            <input type="text" class="form-control" id="nombreContacto" required>
                        </div>
                        <div class="form-group">
                            <label for="emailContacto">Email</label>
                            <input type="email" class="form-control" id="emailContacto" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-person-plus"></i> Agregar Contacto
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card card-contactos">
                <div class="card-body">
                    <h5 class="card-title">Contactos</h5>
                    <div class="mb-3">
                    <input type="text" 
                               class="form-control" 
                               id="buscarContacto" 
                               placeholder="Buscar por nombre...">
                    </div>
                    <div class="list-group" id="listaContactos">
                    </div>
                </div>
            </div>
            
            <div class="card mt-4" id="formEnvio" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">Enviar Dinero</h5>
                    <form id="formEnviarDinero">
                        <input type="hidden" id="contactoSeleccionadoId">
                        <div class="form-group">
                            <label>Enviar a: <span id="nombreDestinatario" class="font-weight-bold"></span></label>
                        </div>
                        <div class="form-group">
                            <label for="montoEnvio">Monto ($)</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">$</span>
                                </div>
                                <input type="number" class="form-control" id="montoEnvio" 
                                       min="0.01" step="0.01" required>
                            </div>
                            <small class="form-text text-muted">
                                Balance disponible: $<span id="balanceDisponible">0</span>
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="descripcionEnvio">Descripción</label>
                            <input type="text" class="form-control" id="descripcionEnvio" 
                                   placeholder="Ej: Pago de servicios">
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="button" id="cancelarEnvio" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-send-check"></i> Enviar Dinero
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="mensajes" class="mt-3"></div>
    </div>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleBtn')
        const navitem = document.querySelectorAll('.nav-item');

        let isCollapsed = false;
        toggleBtn.addEventListener('click', function() {
        isCollapsed = !isCollapsed;

            if (isCollapsed) {
                sidebar.classList.add('collapsed'); 
                toggleBtn.querySelector('i').classList.replace('bi-arrow-left-circle-fill', 'bi-arrow-right-circle-fill');
                navitem.forEach( item => {
                    item.classList.add('collapsed');})    
          }   
            
            else {
                sidebar.classList.remove('collapsed');
                toggleBtn.querySelector('i').classList.replace('bi-arrow-right-circle-fill', 'bi-arrow-left-circle-fill');
                navitem.     forEach( item => {
                    item.classList.remove('collapsed');})
            }

            localStorage.setItem('sidebarCollapsed', isCollapsed);
        });      
    </script>
    <script>
    $(document).ready(function() {
    const CLAVE_CONTACTOS = 'alkeWalletContactos';
    const CLAVE_BALANCE = 'balanceAlkeWallet';
    const CLAVE_HISTORIAL = 'historialTransferencias';
    
    function inicializarContactos() {
        if (!localStorage.getItem(CLAVE_CONTACTOS)) {
            localStorage.setItem(CLAVE_CONTACTOS, JSON.stringify([]));
        }
    }
    
    function cargarContactos() {
        const contactos = JSON.parse(localStorage.getItem(CLAVE_CONTACTOS) || '[]');
        const $lista = $('#listaContactos');
        $lista.empty();
        
        if (contactos.length === 0) {
            $lista.html('<div class="alert alert-info">No tienes contactos agregados</div>');
            return;
        }
        
        contactos.forEach((contacto, index) => {
            $lista.append(`
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${contacto.nombre}</h6>
                        <small class="text-muted">${contacto.email}</small>
                    </div>
                    <button class="btn btn-outline-primary btn-sm btn-enviar" 
                            data-id="${index}"
                            data-nombre="${contacto.nombre}">
                        <i class="bi bi-send"></i> Enviar
                    </button>
                </div>
            `);
        });
    }
    
    $('#buscarContacto').on('input', function() {
        const termino = $(this).val().toLowerCase().trim();
        const contactos = JSON.parse(localStorage.getItem(CLAVE_CONTACTOS) || '[]');
        const $lista = $('#listaContactos');
        
        $lista.empty();
        
        if (contactos.length === 0) {
            $lista.html('<div class="alert alert-info">No tienes contactos agregados</div>');
            return;
        }
        
        const contactosFiltrados = contactos.filter(contacto => 
            contacto.nombre.toLowerCase().includes(termino)
        );
        
        if (contactosFiltrados.length === 0) {
            $lista.html('<div class="alert alert-warning">No se encontraron contactos</div>');
            return;
        }
        
        contactosFiltrados.forEach((contacto, index) => {
            const contactoOriginal = contactos.findIndex(c => c.email === contacto.email);
            
            $lista.append(`
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${contacto.nombre}</h6>
                        <small class="text-muted">${contacto.email}</small>
                    </div>
                    <button class="btn btn-outline-primary btn-sm btn-enviar" 
                            data-id="${contactoOriginal}"
                            data-nombre="${contacto.nombre}">
                        <i class="bi bi-send"></i> Enviar
                    </button>
                </div>
            `);
        });
    });
    
    function actualizarBalanceDisponible() {
        const balance = parseFloat(localStorage.getItem(CLAVE_BALANCE) || '0');
        $('#balanceDisponible').text(balance.toFixed(2));
        return balance;
    }
    
    $('#formAgregarContacto').submit(function(e) {
        e.preventDefault();
        
        const nombre = $('#nombreContacto').val().trim();
        const email = $('#emailContacto').val().trim();
        
        if (!nombre || !email) {
            mostrarMensaje('Por favor completa todos los campos', 'danger');
            return;
        }
        
        const contactos = JSON.parse(localStorage.getItem(CLAVE_CONTACTOS) || '[]');
        
        if (contactos.some(c => c.email === email)) {
            mostrarMensaje('Este contacto ya existe', 'warning');
            return;
        }
        
        contactos.push({ nombre, email });
        localStorage.setItem(CLAVE_CONTACTOS, JSON.stringify(contactos));
        
        $('#buscarContacto').val('');
        cargarContactos();
        
        $('#nombreContacto').val('');
        $('#emailContacto').val('');
        
        mostrarMensaje('Contacto agregado exitosamente', 'success');
    });
    
    $(document).on('click', '.btn-enviar', function() {
        const id = $(this).data('id');
        const nombre = $(this).data('nombre');
        
        $('#contactoSeleccionadoId').val(id);
        $('#nombreDestinatario').text(nombre);
        actualizarBalanceDisponible();
        
        $('#formEnvio').show();
        $('html, body').animate({
            scrollTop: $('#formEnvio').offset().top - 20
        }, 500);
    });
    
    $('#cancelarEnvio').click(function() {
        $('#formEnvio').hide();
        $('#formEnviarDinero')[0].reset();
    });
    
    $('#formEnviarDinero').submit(function(e) {
        e.preventDefault();
        
        const monto = parseFloat($('#montoEnvio').val());
        const descripcion = $('#descripcionEnvio').val().trim();
        const contactoId = $('#contactoSeleccionadoId').val();
        const contactos = JSON.parse(localStorage.getItem(CLAVE_CONTACTOS) || '[]');
        const contacto = contactos[contactoId];
        
        if (isNaN(monto) || monto <= 0) {
            mostrarMensaje('Ingresa un monto válido', 'danger');
            return;
        }
        
        const balanceActual = parseFloat(localStorage.getItem(CLAVE_BALANCE) || '0');
        
        if (monto > balanceActual) {
            mostrarMensaje(`Saldo insuficiente. Disponible: $${balanceActual.toFixed(2)}`, 'danger');
            return;
        }
        
        const nuevoBalance = balanceActual - monto;
        
        localStorage.setItem(CLAVE_BALANCE, nuevoBalance.toFixed(2));
        
        const transferencia = {
            fecha: new Date().toISOString(),
            destinatario: contacto.nombre,
            email: contacto.email,
            monto: monto,
            descripcion: descripcion || 'Sin descripción',
            tipo: 'envío'
        };
        
        let historial = JSON.parse(localStorage.getItem(CLAVE_HISTORIAL) || '[]');
        historial.push(transferencia);
        localStorage.setItem(CLAVE_HISTORIAL, JSON.stringify(historial));
        
        mostrarMensaje(`
            <i class="bi bi-check-circle"></i> 
            ¡Transferencia exitosa!<br>
            Enviaste $${monto.toFixed(2)} a ${contacto.nombre}<br>
            Nuevo balance: $${nuevoBalance.toFixed(2)}
        `, 'success');
        
        $('#formEnviarDinero')[0].reset();
        $('#formEnvio').hide();
        
        actualizarBalanceDisponible();
        
        window.dispatchEvent(new StorageEvent('storage', {
            key: CLAVE_BALANCE
        }));
    });
    
    function mostrarMensaje(texto, tipo) {
        const $mensajes = $('#mensajes');
        $mensajes.html(`
            <div class="alert alert-${tipo} alert-dismissible fade show">
                ${texto}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        `);
        
        setTimeout(() => {
            $mensajes.find('.alert').alert('close');
        }, 5000);
    }
    
    inicializarContactos();
    cargarContactos();
    actualizarBalanceDisponible();
});
    </script>
</body>
</html>